# OpenVPN server config file
# Generated by Chef - local changes will be overwritten

port <%= @config[:port] %>
proto <%= @config[:proto] %>
dev <%= @config[:dev] %>
<% if @config[:mode] == "bridged" -%>
server-bridge <%= "#{@config[:server_ip]} #{@config[:netmask]} #{@config[:dhcp_start]} #{@config[:dhcp_end]}" %>
up "/etc/openvpn/up.sh <%= @config[:network_bridge] %> <%= @config[:network_interface] %>"
down "/etc/openvpn/down.sh <%= @config[:network_bridge] %> <%= @config[:network_interface] %>"
<% else -%>
server <%= "#{@config[:subnet]} #{@config[:netmask]}" %>
local <%= @config[:server_ip] %>
<% end -%>

tmp-dir /tmp
status /var/log/openvpn/<%= @server_name %>-status.log
log-append /var/log/openvpn/<%= @server_name %>.log

<% if @config[:chroot] -%>
crl-verify keys/crl.pem
<% else -%>
crl-verify /etc/openvpn/<%= @server_name %>/keys/crl.pem
<% end -%>

ca   /etc/openvpn/<%= @server_name %>/keys/ca.crt
cert /etc/openvpn/<%= @server_name %>/keys/server.crt
key  /etc/openvpn/<%= @server_name %>/keys/server.key
dh   /etc/openvpn/<%= @server_name %>/keys/dh.pem

<% if @config[:ifconfig_pool_persist] -%>
ifconfig-pool-persist /etc/openvpn/<%= @server_name %>/<%= @server_name %>.ipp
<% end -%>
<% (@config[:push] || []).each do |directive| -%>
<%= "push '#{directive}'" %>
<% end -%>
<%= "push \"redirect-gateway def1\"" if @config[:redirect_gateway] %>
<%= "push \"dhcp-option DNS #{@config[:push_dns_server]}\"" if @config[:push_dns_server] %>


<%= "link-mtu #{@config[:link_mtu]}" if @config[:link_mtu] %>
<%= "cipher #{@config[:tun_mtu]}" if @config[:tun_mtu] %>

<%= "duplicate-cn" if @config[:duplicate_cn] %>
<%= "client-to-client" if @config[:client_to_client] %>
<%= "keepalive #{@config[:keepalive_interval]} #{@config[:keepalive_timeout]}" if @config[:keepalive_interval] and @config[:keepalive_timeout] %>
<%= "comp-lzo" if @config[:comp_lzo] %>
<%= "cipher #{@config[:cipher]}" if @config[:cipher] %>
script-security <%= @config[:script_security] %>
<%= "tls-auth /etc/openvpn/#{@server_name}/keys/ta.key 0" if @config[:use_tls_auth] %>
<%= "chroot /etc/openvpn/#{@server_name}/" if @config[:chroot] %>

<%= 'client-config-dir ccd' if @config[:client_config_dir] %>
<%= 'ccd-exclusive' if @config[:ccd_exclusive] && @config[:client_config_dir] %>

user openvpn
group openvpn

persist-key
persist-tun

verb <%= @config[:verb] %>
mute 20

<% if @config[:use_2fa] -%>
# 2FA
# OTP PLUGIN
plugin "/usr/lib64/openvpn/plugins/openvpn-otp.so" debug=0 otp_secrets=/etc/openvpn/<%= @server_name %>/otp_secrets otp_slop=180 totp_t0=0 totp_step=30 totp_digits=6 motp_step=10
# disable username/password renegotiation"
auth-gen-token"
<% end -%>
